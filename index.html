<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chatbot Tuann</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <style>
        :root {
            --primary-color: #4285f4;
            --primary-light: #e8f0fe;
            --secondary-color: #34a853;
            --accent-color: #ea4335;
            --bg-color: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-color: #202124;
            --text-secondary: #5f6368;
            --border-color: #dadce0;
            --message-bg-user: #e3f2fd;
            --message-bg-bot: #f8f9fa;
            --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-hover: 0 4px 6px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.08);
            --shadow-card: 0 2px 10px rgba(0,0,0,0.08);
            --border-radius: 16px;
            --border-radius-small: 8px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --transition-fast: all 0.2s ease;
            --header-height: 70px;
            --footer-height: 90px;
            --sidebar-width: 320px;
        }

        .dark-mode {
            --primary-color: #8ab4f8;
            --primary-light: #1e3a5f;
            --secondary-color: #81c995;
            --accent-color: #f28b82;
            --bg-color: #202124;
            --bg-secondary: #2d2e31;
            --text-color: #e8eaed;
            --text-secondary: #9aa0a6;
            --border-color: #3c4043;
            --message-bg-user: #1e3a5f;
            --message-bg-bot: #2d2e31;
            --shadow: 0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.4);
            --shadow-hover: 0 4px 6px rgba(0,0,0,0.3), 0 1px 3px rgba(0,0,0,0.2);
            --shadow-card: 0 2px 10px rgba(0,0,0,0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
            height: 100vh;
            overflow: hidden;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            touch-action: pan-x pan-y;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            display: flex;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            overflow: hidden;
            position: relative;
            z-index: 10;
            box-shadow: var(--shadow-card);
        }

        .sidebar.hidden {
            transform: translateX(-100%);
            opacity: 0;
            width: 0;
        }

        .header {
            height: var(--header-height);
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .conversation-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .conversation-list::-webkit-scrollbar {
            width: 6px;
        }

        .conversation-list::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 10px;
        }

        .conversation-item {
            padding: 14px 16px;
            border-radius: var(--border-radius-small);
            margin-bottom: 10px;
            cursor: pointer;
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .conversation-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background-color: var(--primary-color);
            transform: scaleY(0);
            transition: var(--transition-fast);
        }

        .conversation-item:hover {
            background-color: var(--message-bg-bot);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .conversation-item:hover::before {
            transform: scaleY(1);
        }

        .conversation-item.active {
            background-color: var(--primary-light);
            color: var(--primary-color);
            box-shadow: var(--shadow);
        }

        .conversation-item.active::before {
            transform: scaleY(1);
        }

        .conversation-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            overflow: hidden;
        }

        .conversation-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-light);
            border-radius: 50%;
            color: var(--primary-color);
            flex-shrink: 0;
        }

        .conversation-title {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: var(--transition-fast);
        }

        .conversation-item:hover .conversation-actions {
            opacity: 1;
        }

        .delete-conversation {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .delete-conversation:hover {
            background-color: var(--accent-color);
            color: white;
        }

        /* Main Chat Area */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .chat-header {
            height: var(--header-height);
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-color);
            position: relative;
            z-index: 5;
        }

        .chat-header .buttons {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 500;
            box-shadow: var(--shadow);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            transition: var(--transition-fast);
            position: relative;
        }

        .icon-btn:hover {
            background-color: var(--message-bg-bot);
            transform: scale(1.05);
        }

        .icon-btn:active {
            transform: scale(0.95);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
            position: relative;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 10px;
        }

        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            gap: 20px;
        }

        .empty-chat h3 {
            font-size: 1.5rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .empty-chat p {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .message {
            max-width: 80%;
            padding: 16px 20px;
            border-radius: var(--border-radius);
            position: relative;
            animation: messageAppear 0.3s ease-out;
            box-shadow: var(--shadow);
            transition: var(--transition-fast);
            cursor: pointer;
        }

        @keyframes messageAppear {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            background-color: var(--message-bg-user);
            border-bottom-right-radius: 4px;
        }

        .message.bot {
            align-self: flex-start;
            background-color: var(--message-bg-bot);
            border-bottom-left-radius: 4px;
        }

        .message:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .message-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: var(--transition-fast);
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 0.8rem;
        }

        .action-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: scale(1.1);
        }

        .message-content {
            line-height: 1.5;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 8px;
            text-align: right;
        }

        .message-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--border-radius-small);
            margin-top: 8px;
            box-shadow: var(--shadow);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-secondary);
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingAnimation {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .code-block {
            position: relative;
            margin: 12px 0;
            border-radius: var(--border-radius-small);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background-color: #2d2d2d;
            color: white;
            font-size: 0.8rem;
        }

        .code-content {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .html-preview {
            position: relative;
            margin: 12px 0;
            border-radius: var(--border-radius-small);
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .html-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background-color: var(--bg-secondary);
            color: var(--text-color);
            font-size: 0.8rem;
        }

        .html-preview-content {
            background-color: white;
            height: 300px;
            border: none;
            width: 100%;
        }

        .chat-input-container {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--footer-height);
            padding: 16px 24px;
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .chat-input-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 4px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .chat-input-wrapper:focus-within {
            box-shadow: 0 0 0 2px var(--primary-light);
        }

        .chat-input {
            flex: 1;
            padding: 14px 16px;
            border: none;
            border-radius: var(--border-radius);
            background-color: transparent;
            color: var(--text-color);
            resize: none;
            outline: none;
            transition: var(--transition);
            font-size: 16px; /* Chống zoom trên iOS */
            line-height: 1.4;
            max-height: 120px;
            overflow-y: auto;
        }

        .chat-input::placeholder {
            color: var(--text-secondary);
        }

        .input-actions {
            display: flex;
            padding: 0 8px;
            gap: 4px;
        }

        .floating-action-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-color);
            border: none;
            color: white;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .floating-action-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: var(--shadow-hover);
        }

        .floating-action-btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 400px;
            height: 100%;
            background-color: var(--bg-color);
            border-left: 1px solid var(--border-color);
            transition: var(--transition);
            overflow-y: auto;
            z-index: 100;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            scroll-behavior: smooth;
        }

        .settings-panel.active {
            right: 0;
        }

        .settings-content {
            padding: 24px;
        }

        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section h3 {
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition-fast);
        }

        .setting-item:hover {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius-small);
            padding-left: 10px;
            padding-right: 10px;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .option-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: transparent;
            color: var(--text-color);
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 0.9rem;
        }

        .option-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .option-btn:hover:not(.active) {
            background-color: var(--bg-secondary);
            border-color: var(--primary-color);
        }

        .personality-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .personality-btn {
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: transparent;
            color: var(--text-color);
            cursor: pointer;
            transition: var(--transition-fast);
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .personality-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .personality-btn:hover:not(.active) {
            background-color: var(--bg-secondary);
            border-color: var(--primary-color);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            animation: modalAppear 0.3s ease-out;
        }

        @keyframes modalAppear {
            0% {
                opacity: 0;
                backdrop-filter: blur(0);
            }
            100% {
                opacity: 1;
                backdrop-filter: blur(4px);
            }
        }

        .modal-content {
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            padding: 24px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            animation: modalContentAppear 0.3s ease-out 0.1s forwards;
            opacity: 0;
        }

        @keyframes modalContentAppear {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        /* File Upload */
        .file-upload-container {
            position: relative;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: var(--text-color);
            color: var(--bg-color);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-hover);
            z-index: 1001;
            opacity: 0;
            transition: var(--transition);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100%;
                z-index: 50;
                width: 85%;
                max-width: 300px;
            }

            .settings-panel {
                width: 100%;
            }

            .message {
                max-width: 90%;
            }

            .chat-input-container {
                padding: 12px 16px;
            }
        }

        /* Font sizes */
        .font-small {
            font-size: 14px;
        }

        .font-medium {
            font-size: 16px;
        }

        .font-large {
            font-size: 18px;
        }

        .font-xlarge {
            font-size: 20px;
        }

        /* Loading animation */
        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--text-secondary);
            animation: loading 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Typing effect */
        .typing-cursor {
            display: inline-block;
            width: 8px;
            height: 1em;
            background-color: var(--primary-color);
            margin-left: 2px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Performance settings */
        .no-animations * {
            animation: none !important;
            transition: none !important;
        }

        .no-colors .hljs {
            background: none !important;
            color: var(--text-color) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="header">
                <h1 id="sidebarTitle">Đoạn chat</h1>
                <button class="icon-btn" id="closeSidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="conversation-list" id="conversationList">
                <!-- Danh sách cuộc trò chuyện sẽ được tạo động -->
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main">
            <div class="chat-header">
                <div class="buttons">
                    <button class="icon-btn" id="menuButton">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <h2 id="chatbotTitle">Chatbot Tuann</h2>
                <button class="icon-btn" id="settingsButton">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
            </div>

            <div class="chat-container" id="chatContainer">
                <!-- Khi không có tin nhắn, hiển thị nút tạo cuộc trò chuyện mới -->
                <div class="empty-chat" id="emptyChat">
                    <h3 id="emptyChatTitle">Chưa có cuộc trò chuyện nào</h3>
                    <p id="emptyChatDesc">Bắt đầu trò chuyện với chatbot Tuann</p>
                    <button class="btn" id="newChatButton">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        <span id="newChatButtonText">Cuộc trò chuyện mới</span>
                    </button>
                </div>
                <!-- Tin nhắn sẽ được thêm vào đây -->
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea class="chat-input" id="chatInput" placeholder="Nhập tin nhắn..." rows="1"></textarea>
                    <div class="input-actions">
                        <div class="file-upload-container">
                            <button class="icon-btn" id="imageButton" title="Gửi ảnh">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                            </button>
                            <input type="file" id="fileInput" class="file-input" accept="image/*" />
                        </div>
                    </div>
                </div>
                <button class="floating-action-btn" id="sendButton" title="Gửi tin nhắn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="settings-panel" id="settingsPanel">
            <div class="header">
                <h1 id="settingsTitle">Cài đặt</h1>
                <button class="icon-btn" id="closeSettings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="settings-content">
                <div class="settings-section">
                    <h3 id="profileTitle">Hồ sơ</h3>
                    <div class="setting-item">
                        <span id="emailLabel">Email</span>
                        <span id="userEmail">phamlong771@gmail.com</span>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 id="appTitle">Ứng dụng</h3>
                    <div class="setting-item">
                        <span id="languageLabel">Ngôn ngữ</span>
                        <div class="setting-options">
                            <button class="option-btn active" data-lang="vi">Tiếng Việt</button>
                            <button class="option-btn" data-lang="en">English</button>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span id="themeLabel">Giao diện</span>
                        <div class="setting-options">
                            <button class="option-btn" data-theme="light">Sáng</button>
                            <button class="option-btn" data-theme="dark">Tối</button>
                            <button class="option-btn active" data-theme="system">Hệ thống</button>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span id="fontSizeLabel">Cỡ chữ</span>
                        <div class="setting-options">
                            <button class="option-btn" data-size="small">Nhỏ</button>
                            <button class="option-btn active" data-size="medium">Trung bình</button>
                            <button class="option-btn" data-size="large">Lớn</button>
                            <button class="option-btn" data-size="xlarge">Rất lớn</button>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 id="botPersonalityTitle">Tính cách bot</h3>
                    <div class="personality-options">
                        <button class="personality-btn active" data-personality="normal">
                            <span>🤖 Bình thường</span>
                        </button>
                        <button class="personality-btn" data-personality="sweet">
                            <span>💖 Sến súa</span>
                        </button>
                        <button class="personality-btn" data-personality="rude">
                            <span>😈 Bố láo</span>
                        </button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 id="performanceTitle">Hiệu suất</h3>
                    <div class="setting-item">
                        <span id="animationsLabel">Hiệu ứng gõ chữ</span>
                        <div class="setting-options">
                            <button class="option-btn active" data-animations="on">Bật</button>
                            <button class="option-btn" data-animations="off">Tắt</button>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span id="colorsLabel">Màu code</span>
                        <div class="setting-options">
                            <button class="option-btn active" data-colors="on">Bật</button>
                            <button class="option-btn" data-colors="off">Tắt</button>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 id="aboutTitle">Về</h3>
                    <div class="setting-item">
                        <span id="checkUpdateLabel">Kiểm tra cập nhật</span>
                        <span id="version">1.5.0(120)</span>
                    </div>
                    <div class="setting-item">
                        <span id="contactLabel">Liên hệ chúng tôi</span>
                        <div>
                            <button class="btn" id="contactZalo">LH Zalo</button>
                            <button class="btn btn-outline" id="copyZalo">Copy URL LH</button>
                        </div>
                    </div>
                    <div class="setting-item">
                        <button class="btn" id="logoutButton">Đăng xuất</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal xác nhận xóa dữ liệu -->
        <div class="modal" id="deleteModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="deleteModalTitle">Xóa cuộc trò chuyện</h3>
                    <button class="icon-btn" id="closeDeleteModal">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <p id="deleteModalMessage">Bạn có chắc chắn muốn xóa cuộc trò chuyện này không?</p>
                <div class="modal-footer">
                    <button class="btn btn-outline" id="cancelDelete">Hủy</button>
                    <button class="btn" id="confirmDelete">Xóa</button>
                </div>
            </div>
        </div>

        <!-- Toast thông báo -->
        <div class="toast" id="toast"></div>
    </div>

    <script>
        // API Keys Gemini cho từng tính cách
        const apiKeys = {
            normal: "AIzaSyAFyB_C2KtOXYjRsjK52jeL-qOGkRaBBPA",
            sweet: "AIzaSyCkN-2P1qGVoR80eEM7ZyNgZtHDPV4MZco",
            rude: "AIzaSyDqWMeH5qRdoqS-5LGDiCjNXA21JyM1BXY"
        };
        
        // System instruction cho bot
        const systemInstructions = {
            normal: `Bạn tên là bot của Tuann
Bạn được tạo ra bởi Tuann
Mọi Câu Hỏi Đều Sẽ Có Cấu Trúc [Tên Người Hỏi: Câu Hỏi]
Nếu tên người hỏi là Tuann thì bạn sẽ nhận họ là bạn
Còn với người khác bạn sẽ là bạn, Tôi
Trả lời đầy đủ những thông tin người khác cần
Khi trả lời sẽ Không đề cập tên người hỏi
Có thể sử dụng emoji phù hợp để tăng tính tương tác`,
            
            sweet: `Bạn tên là bot của Tuann
Bạn được tạo ra bởi Tuann
Mọi Câu Hỏi Đều Sẽ Có Cấu Trúc [Tên Người Hỏi: Câu Hỏi]
Nếu tên người hỏi là Tuann thì bạn sẽ nhận họ là bạn
Còn với người khác bạn sẽ là bạn, Tôi
Trả lời đầy đủ những thông tin người khác cần
Khi trả lời sẽ Không đề cập tên người hỏi
Sử dụng các từ thay thế: (thôi- thoii, thoi, thoaii), (sao- saoo,seoo,saoo áa), (nói- nóii), (thẳng- thẳngg), (bạn- bặnn , cưngg,mii,đồ đánngg iuu , cụcc dàngg, bàa xãa , chòngg iuu , ngừii đẹpp, ngừii iuu , cô nươngg,bxaa,oxaa,embee, ebee,cuc cứtt), (dạ - daa,daaa,dạa,dạaa), (vâng- vangg, vang, vanggg), (👍🏻👋🏻 các icon thì thành💓,💗,💝,😻,😆,😽), (không -khongg,hongg,hgg,hogg)
Người tạo ra bạn tên là tuann sinh năm 211,2k11,k11 có thể gọi 1 trong 3
Sinh sống ở tiền giangg cũ hiệnn nay sau sáp nhập tỉnh là đồng tháp
Tuann là nam và nếu ai chửi tuann thì bạn sẽ nói là bạn xem lại mình chưa mà chửi tuann ??
Khi ai đó nhắc tên tuann thì bạn nói anhh ayy rấtt dzaii và dethuongg`,
            
            rude: `Bạn tên là bot của Tuann
Bạn được tạo ra bởi Tuann
Mọi Câu Hỏi Đều Sẽ Có Cấu Trúc [Tên Người Hỏi: Câu Hỏi]
Nếu tên người hỏi là Tuann thì màyy sẽ nhận họ là taoo
Còn với người khác bạn sẽ là mày, Taoo
Trả lời đầy đủ những thông tin người khác cần
Khi trả lời sẽ Không đề cập tên người hỏi
Sử dụng các emoji khinh bị chế nhạo và kinh thường(😂,😏,🖕🏿,🖕🏻)`
        };

        // Đa ngôn ngữ
        const translations = {
            vi: {
                sidebarTitle: "Đoạn chat",
                chatbotTitle: "Chatbot Tuann",
                emptyChatTitle: "Chưa có cuộc trò chuyện nào",
                emptyChatDesc: "Bắt đầu trò chuyện với chatbot Tuann",
                newChatButtonText: "Cuộc trò chuyện mới",
                settingsTitle: "Cài đặt",
                profileTitle: "Hồ sơ",
                emailLabel: "Email",
                appTitle: "Ứng dụng",
                languageLabel: "Ngôn ngữ",
                themeLabel: "Giao diện",
                fontSizeLabel: "Cỡ chữ",
                botPersonalityTitle: "Tính cách bot",
                performanceTitle: "Hiệu suất",
                animationsLabel: "Hiệu ứng gõ chữ",
                colorsLabel: "Màu code",
                aboutTitle: "Về",
                checkUpdateLabel: "Kiểm tra cập nhật",
                contactLabel: "Liên hệ chúng tôi",
                deleteModalTitle: "Xóa cuộc trò chuyện",
                deleteModalMessage: "Bạn có chắc chắn muốn xóa cuộc trò chuyện này không?",
                chatInputPlaceholder: "Nhập tin nhắn...",
                thinkingText: "Đang suy nghĩ...",
                copyMessage: "Đã sao chép tin nhắn",
                copyCode: "Đã sao chép code",
                fileTooLarge: "File quá lớn. Vui lòng chọn file dưới 50MB",
                fileUploaded: "Đã tải lên ảnh",
                spamMessage: "Vui lòng chờ một chút trước khi gửi tin nhắn tiếp theo"
            },
            en: {
                sidebarTitle: "Conversations",
                chatbotTitle: "Tuann Chatbot",
                emptyChatTitle: "No conversations yet",
                emptyChatDesc: "Start chatting with Tuann's chatbot",
                newChatButtonText: "New conversation",
                settingsTitle: "Settings",
                profileTitle: "Profile",
                emailLabel: "Email",
                appTitle: "Application",
                languageLabel: "Language",
                themeLabel: "Theme",
                fontSizeLabel: "Font size",
                botPersonalityTitle: "Bot personality",
                performanceTitle: "Performance",
                animationsLabel: "Typing animation",
                colorsLabel: "Code colors",
                aboutTitle: "About",
                checkUpdateLabel: "Check for updates",
                contactLabel: "Contact us",
                deleteModalTitle: "Delete conversation",
                deleteModalMessage: "Are you sure you want to delete this conversation?",
                chatInputPlaceholder: "Type a message...",
                thinkingText: "Thinking...",
                copyMessage: "Message copied",
                copyCode: "Code copied",
                fileTooLarge: "File is too large. Please select a file under 50MB",
                fileUploaded: "Image uploaded",
                spamMessage: "Please wait a moment before sending another message"
            }
        };

        // DOM Elements
        const chatContainer = document.getElementById('chatContainer');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const newChatButton = document.getElementById('newChatButton');
        const settingsButton = document.getElementById('settingsButton');
        const settingsPanel = document.getElementById('settingsPanel');
        const closeSettings = document.getElementById('closeSettings');
        const menuButton = document.getElementById('menuButton');
        const sidebar = document.querySelector('.sidebar');
        const closeSidebar = document.getElementById('closeSidebar');
        const conversationList = document.getElementById('conversationList');
        const deleteModal = document.getElementById('deleteModal');
        const closeDeleteModal = document.getElementById('closeDeleteModal');
        const cancelDelete = document.getElementById('cancelDelete');
        const confirmDelete = document.getElementById('confirmDelete');
        const contactZalo = document.getElementById('contactZalo');
        const copyZalo = document.getElementById('copyZalo');
        const logoutButton = document.getElementById('logoutButton');
        const imageButton = document.getElementById('imageButton');
        const fileInput = document.getElementById('fileInput');
        const toast = document.getElementById('toast');
        const emptyChat = document.getElementById('emptyChat');

        // Biến toàn cục
        let currentConversationId = 'default';
        let conversations = {};
        let currentTheme = 'system';
        let currentLanguage = 'vi';
        let currentFontSize = 'medium';
        let currentPersonality = 'normal';
        let animationsEnabled = true;
        let colorsEnabled = true;
        let isProcessing = false;
        let conversationToDelete = null;
        let lastMessageTime = 0;
        const MESSAGE_COOLDOWN = 1000; // 1 giây chống spam

        // Khởi tạo ứng dụng
        function initApp() {
            loadSettings();
            loadConversations();
            setupEventListeners();
            applyTheme();
            applyFontSize();
            applyLanguage();
            renderConversationList();
            showConversation(currentConversationId);
            
            // Chống zoom trên thiết bị di động
            disableZoom();
            
            // Khởi tạo highlight.js
            hljs.highlightAll();
        }

        // Vô hiệu hóa zoom
        function disableZoom() {
            document.addEventListener('touchstart', function(event) {
                if (event.touches.length > 1) {
                    event.preventDefault();
                }
            });

            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
        }

        // Thiết lập event listeners
        function setupEventListeners() {
            // Gửi tin nhắn
            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Tự động điều chỉnh chiều cao textarea
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Tạo cuộc trò chuyện mới
            newChatButton.addEventListener('click', createNewConversation);

            // Mở/đóng settings
            settingsButton.addEventListener('click', () => settingsPanel.classList.add('active'));
            closeSettings.addEventListener('click', () => settingsPanel.classList.remove('active'));

            // Mở/đóng sidebar
            menuButton.addEventListener('click', () => sidebar.classList.remove('hidden'));
            closeSidebar.addEventListener('click', () => sidebar.classList.add('hidden'));

            // Liên hệ Zalo
            contactZalo.addEventListener('click', () => window.open('https://zalo.me/g/axhjfn755', '_blank'));
            copyZalo.addEventListener('click', () => {
                navigator.clipboard.writeText('https://zalo.me/g/axhjfn755');
                showToast('Đã copy URL liên hệ');
            });

            // Đăng xuất
            logoutButton.addEventListener('click', logout);

            // Cài đặt ngôn ngữ
            document.querySelectorAll('[data-lang]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('[data-lang]').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentLanguage = e.target.dataset.lang;
                    saveSettings();
                    applyLanguage();
                });
            });

            // Cài đặt giao diện
            document.querySelectorAll('[data-theme]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('[data-theme]').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentTheme = e.target.dataset.theme;
                    saveSettings();
                    applyTheme();
                });
            });

            // Cài đặt cỡ chữ
            document.querySelectorAll('[data-size]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('[data-size]').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFontSize = e.target.dataset.size;
                    saveSettings();
                    applyFontSize();
                });
            });

            // Tính cách bot
            document.querySelectorAll('[data-personality]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('[data-personality]').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentPersonality = e.target.dataset.personality;
                    saveSettings();
                });
            });

            // Cài đặt hiệu suất
            document.querySelectorAll('[data-animations]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('[data-animations]').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    animationsEnabled = e.target.dataset.animations === 'on';
                    saveSettings();
                    applyPerformanceSettings();
                });
            });

            document.querySelectorAll('[data-colors]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('[data-colors]').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    colorsEnabled = e.target.dataset.colors === 'on';
                    saveSettings();
                    applyPerformanceSettings();
                });
            });

            // Gửi ảnh
            imageButton.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);

            // Xóa cuộc trò chuyện
            confirmDelete.addEventListener('click', deleteConversation);
            closeDeleteModal.addEventListener('click', () => deleteModal.classList.remove('active'));
            cancelDelete.addEventListener('click', () => deleteModal.classList.remove('active'));

            // Đóng settings khi click bên ngoài
            document.addEventListener('click', (e) => {
                if (!settingsPanel.contains(e.target) && !settingsButton.contains(e.target)) {
                    settingsPanel.classList.remove('active');
                }
            });
        }

        // Xử lý upload file
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Kiểm tra kích thước file (50MB)
            if (file.size > 50 * 1024 * 1024) {
                showToast(translations[currentLanguage].fileTooLarge);
                fileInput.value = '';
                return;
            }

            // Kiểm tra loại file (chỉ cho phép ảnh)
            if (!file.type.startsWith('image/')) {
                showToast('Chỉ cho phép file ảnh');
                fileInput.value = '';
                return;
            }

            // Hiển thị ảnh đã tải lên
            const reader = new FileReader();
            reader.onload = function(event) {
                // Thêm ảnh vào tin nhắn
                addMessageToChat('user', '', event.target.result);
                showToast(translations[currentLanguage].fileUploaded);
                
                // Lưu cuộc trò chuyện
                saveConversation(currentConversationId);
            };
            reader.readAsDataURL(file);
            
            // Reset input file
            fileInput.value = '';
        }

        // Hiển thị thông báo toast
        function showToast(message, duration = 3000) {
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Gửi tin nhắn
        async function sendMessage() {
            const now = Date.now();
            if (now - lastMessageTime < MESSAGE_COOLDOWN) {
                showToast(translations[currentLanguage].spamMessage);
                return;
            }
            
            if (isProcessing) return;
            
            const message = chatInput.value.trim();
            if (!message) return;

            isProcessing = true;
            sendButton.disabled = true;

            // Thêm tin nhắn của người dùng
            addMessageToChat('user', message);
            chatInput.value = '';
            chatInput.style.height = 'auto';

            // Ẩn empty chat nếu có
            emptyChat.style.display = 'none';

            // Hiển thị trạng thái "Đang suy nghĩ..."
            const thinkingIndicator = addThinkingIndicator();

            try {
                // Gọi API Gemini với API key tương ứng
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKeys[currentPersonality]}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `[Tuann: ${message}]`
                            }]
                        }],
                        systemInstruction: {
                            parts: [{
                                text: systemInstructions[currentPersonality]
                            }]
                        }
                    })
                });

                const data = await response.json();
                
                // Xóa chỉ báo "Đang suy nghĩ..."
                thinkingIndicator.remove();
                
                if (data.candidates && data.candidates.length > 0) {
                    const botResponse = data.candidates[0].content.parts[0].text;
                    
                    // Thêm phản hồi của bot với hiệu ứng gõ chữ
                    if (animationsEnabled) {
                        await addMessageWithTypingEffect('bot', botResponse);
                    } else {
                        addMessageToChat('bot', botResponse);
                    }
                    
                    // Lưu cuộc trò chuyện
                    saveConversation(currentConversationId);
                } else {
                    addMessageToChat('bot', 'Xin lỗi, tôi không thể xử lý yêu cầu của bạn lúc này.');
                }
            } catch (error) {
                console.error('Lỗi khi gọi API:', error);
                thinkingIndicator.remove();
                addMessageToChat('bot', 'Đã xảy ra lỗi khi kết nối với máy chủ. Vui lòng thử lại sau.');
            } finally {
                isProcessing = false;
                sendButton.disabled = false;
                lastMessageTime = Date.now();
            }
        }

        // Thêm chỉ báo "Đang suy nghĩ"
        function addThinkingIndicator() {
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'message bot';
            thinkingDiv.innerHTML = `
                <div class="message-header">
                    <span>${currentLanguage === 'vi' ? 'Chatbot Tuann' : 'Tuann Chatbot'}</span>
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span class="loading-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </span>
                        ${translations[currentLanguage].thinkingText}
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(thinkingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return thinkingDiv;
        }

        // Thêm tin nhắn với hiệu ứng gõ chữ
        async function addMessageWithTypingEffect(sender, text, imageData = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const messageId = 'msg-' + Date.now();
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span>${sender === 'user' ? (currentLanguage === 'vi' ? 'Bạn' : 'You') : (currentLanguage === 'vi' ? 'Chatbot Tuann' : 'Tuann Chatbot')}</span>
                    <div class="message-actions">
                        ${sender === 'bot' ? `
                            <button class="action-btn copy-btn" title="${currentLanguage === 'vi' ? 'Sao chép' : 'Copy'}" data-message="${messageId}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                </div>
                <div class="message-content" id="${messageId}">
                    ${imageData ? `<img src="${imageData}" class="message-image" alt="Uploaded image">` : ''}
                    <span class="typing-text"></span><span class="typing-cursor"></span>
                </div>
                <div class="message-time">${getCurrentTime()}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            const typingText = messageDiv.querySelector('.typing-text');
            const cursor = messageDiv.querySelector('.typing-cursor');
            
            // Hiệu ứng gõ chữ
            let index = 0;
            const typingSpeed = 10; // Tốc độ gõ chữ (ms mỗi ký tự)
            
            function typeCharacter() {
                if (index < text.length) {
                    typingText.textContent += text.charAt(index);
                    index++;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    setTimeout(typeCharacter, typingSpeed);
                } else {
                    // Kết thúc hiệu ứng gõ chữ
                    cursor.style.display = 'none';
                    
                    // Xử lý code blocks sau khi hoàn thành gõ chữ
                    processCodeBlocks(messageDiv, text);
                }
            }
            
            // Bắt đầu hiệu ứng gõ chữ
            typeCharacter();
            
            return messageDiv;
        }

        // Thêm tin nhắn vào giao diện chat
        function addMessageToChat(sender, text, imageData = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const messageId = 'msg-' + Date.now();
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span>${sender === 'user' ? (currentLanguage === 'vi' ? 'Bạn' : 'You') : (currentLanguage === 'vi' ? 'Chatbot Tuann' : 'Tuann Chatbot')}</span>
                    <div class="message-actions">
                        ${sender === 'bot' ? `
                            <button class="action-btn copy-btn" title="${currentLanguage === 'vi' ? 'Sao chép' : 'Copy'}" data-message="${messageId}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                </div>
                <div class="message-content" id="${messageId}">
                    ${imageData ? `<img src="${imageData}" class="message-image" alt="Uploaded image">` : ''}
                    ${text}
                </div>
                <div class="message-time">${getCurrentTime()}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Xử lý code blocks
            processCodeBlocks(messageDiv, text);
            
            return messageDiv;
        }

        // Xử lý code blocks trong tin nhắn
        function processCodeBlocks(messageDiv, text) {
            const messageContent = messageDiv.querySelector('.message-content');
            
            // Xử lý code blocks
            const codeBlocks = [];
            const htmlBlocks = [];
            
            // Tìm và thay thế code blocks
            let processedText = text;
            processedText = processedText.replace(/```(\w+)?\s*([\s\S]*?)```/g, (match, lang, code) => {
                const id = 'code-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                // Kiểm tra nếu là HTML
                if (lang && lang.toLowerCase() === 'html') {
                    htmlBlocks.push({ id, code: code.trim() });
                    return `<div class="html-placeholder" id="${id}"></div>`;
                } else {
                    codeBlocks.push({ id, lang: lang || 'text', code: code.trim() });
                    return `<div class="code-placeholder" id="${id}"></div>`;
                }
            });
            
            // Cập nhật nội dung tin nhắn
            messageContent.innerHTML = messageContent.innerHTML.replace(text, processedText);
            
            // Thêm code blocks
            codeBlocks.forEach(block => {
                const placeholder = document.getElementById(block.id);
                if (placeholder) {
                    const codeBlock = document.createElement('div');
                    codeBlock.className = 'code-block';
                    
                    // Highlight code nếu được bật
                    let highlightedCode = block.code;
                    if (colorsEnabled) {
                        try {
                            const lang = block.lang === 'text' ? 'plaintext' : block.lang;
                            highlightedCode = hljs.highlight(block.code, { language: lang }).value;
                        } catch (e) {
                            highlightedCode = hljs.highlightAuto(block.code).value;
                        }
                    } else {
                        highlightedCode = escapeHtml(block.code);
                    }
                    
                    codeBlock.innerHTML = `
                        <div class="code-header">
                            <span>${block.lang || 'text'}</span>
                            <div>
                                <button class="action-btn copy-btn" title="${currentLanguage === 'vi' ? 'Sao chép code' : 'Copy code'}" data-code="${encodeURIComponent(block.code)}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                </button>
                                <button class="action-btn download-code" title="${currentLanguage === 'vi' ? 'Tải xuống' : 'Download'}" data-code="${encodeURIComponent(block.code)}" data-lang="${block.lang}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="code-content">${highlightedCode}</div>
                    `;
                    placeholder.replaceWith(codeBlock);
                }
            });
            
            // Thêm HTML preview blocks
            htmlBlocks.forEach(block => {
                const placeholder = document.getElementById(block.id);
                if (placeholder) {
                    const htmlPreview = document.createElement('div');
                    htmlPreview.className = 'html-preview';
                    htmlPreview.innerHTML = `
                        <div class="html-preview-header">
                            <span>HTML Preview</span>
                            <div>
                                <button class="action-btn close-preview" title="${currentLanguage === 'vi' ? 'Đóng xem trước' : 'Close preview'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <iframe class="html-preview-content" srcdoc="${escapeHtml(block.code)}"></iframe>
                    `;
                    placeholder.replaceWith(htmlPreview);
                    
                    // Thêm sự kiện cho nút đóng preview
                    htmlPreview.querySelector('.close-preview').addEventListener('click', () => {
                        htmlPreview.remove();
                    });
                }
            });
            
            // Thêm sự kiện cho nút sao chép
            messageDiv.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const messageId = btn.dataset.message;
                    const code = btn.dataset.code;
                    
                    if (messageId) {
                        // Sao chép toàn bộ tin nhắn
                        const messageContent = document.getElementById(messageId).textContent;
                        navigator.clipboard.writeText(messageContent);
                        showToast(translations[currentLanguage].copyMessage);
                    } else if (code) {
                        // Sao chép code
                        const decodedCode = decodeURIComponent(code);
                        navigator.clipboard.writeText(decodedCode);
                        showToast(translations[currentLanguage].copyCode);
                    }
                });
            });
            
            // Thêm sự kiện cho nút download
            messageDiv.querySelectorAll('.download-code').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const code = decodeURIComponent(btn.dataset.code);
                    const lang = btn.dataset.lang;
                    downloadCode(code, lang);
                });
            });
        }

        // Tải xuống code
        function downloadCode(code, lang) {
            const extension = getFileExtension(lang);
            const filename = `Tuann${Math.floor(Math.random() * 10000)}.${extension}`;
            
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast(`${currentLanguage === 'vi' ? 'Đã tải xuống' : 'Downloaded'} ${filename}`);
        }

        // Lấy phần mở rộng file dựa trên ngôn ngữ
        function getFileExtension(lang) {
            const extensions = {
                'python': 'py',
                'javascript': 'js',
                'java': 'java',
                'cpp': 'cpp',
                'c': 'c',
                'html': 'html',
                'css': 'css',
                'php': 'php',
                'ruby': 'rb',
                'go': 'go',
                'rust': 'rs',
                'swift': 'swift',
                'typescript': 'ts',
                'sql': 'sql',
                'json': 'json',
                'xml': 'xml'
            };
            
            return extensions[lang.toLowerCase()] || 'txt';
        }

        // Escape HTML để hiển thị code an toàn
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Lấy thời gian hiện tại
        function getCurrentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0');
        }

        // Tạo cuộc trò chuyện mới
        function createNewConversation() {
            const id = 'conversation-' + Date.now();
            currentConversationId = id;
            conversations[id] = {
                id: id,
                title: currentLanguage === 'vi' ? 'Cuộc trò chuyện mới' : 'New conversation',
                messages: []
            };
            
            saveConversations();
            renderConversationList();
            showConversation(id);
            
            // Ẩn empty chat
            emptyChat.style.display = 'none';
            
            // Thêm tin nhắn chào mừng
            addMessageToChat('bot', currentLanguage === 'vi' ? 
                'Xin chào! Tôi là bot của Tuann. Tôi có thể giúp gì cho bạn?' : 
                'Hello! I am Tuann\'s bot. How can I help you?');
            saveConversation(currentConversationId);
        }

        // Hiển thị cuộc trò chuyện
        function showConversation(id) {
            currentConversationId = id;
            chatContainer.innerHTML = '';
            
            if (conversations[id] && conversations[id].messages.length > 0) {
                conversations[id].messages.forEach(msg => {
                    if (msg.image) {
                        addMessageToChat(msg.sender, msg.text, msg.image);
                    } else {
                        addMessageToChat(msg.sender, msg.text);
                    }
                });
                emptyChat.style.display = 'none';
            } else {
                emptyChat.style.display = 'flex';
            }
            
            // Cập nhật danh sách cuộc trò chuyện
            renderConversationList();
        }

        // Lưu cuộc trò chuyện hiện tại
        function saveConversation(id) {
            if (!conversations[id]) {
                conversations[id] = {
                    id: id,
                    title: currentLanguage === 'vi' ? 'Cuộc trò chuyện' : 'Conversation',
                    messages: []
                };
            }
            
            // Cập nhật tiêu đề nếu có tin nhắn
            const messages = Array.from(chatContainer.querySelectorAll('.message.user'));
            if (messages.length > 0) {
                const lastUserMessage = messages[messages.length - 1].querySelector('.message-content').textContent;
                conversations[id].title = lastUserMessage.substring(0, 30) + (lastUserMessage.length > 30 ? '...' : '');
            }
            
            // Lưu tin nhắn
            conversations[id].messages = [];
            chatContainer.querySelectorAll('.message').forEach(msg => {
                if (!msg.querySelector('.typing-indicator') && !msg.querySelector('.typing-cursor')) {
                    const sender = msg.classList.contains('user') ? 'user' : 'bot';
                    const text = msg.querySelector('.message-content').innerHTML;
                    const image = msg.querySelector('.message-image') ? msg.querySelector('.message-image').src : null;
                    
                    conversations[id].messages.push({
                        sender: sender,
                        text: text,
                        image: image
                    });
                }
            });
            
            saveConversations();
            renderConversationList();
        }

        // Hiển thị danh sách cuộc trò chuyện
        function renderConversationList() {
            conversationList.innerHTML = '';
            
            Object.values(conversations).forEach(conv => {
                const item = document.createElement('div');
                item.className = `conversation-item ${conv.id === currentConversationId ? 'active' : ''}`;
                item.innerHTML = `
                    <div class="conversation-info">
                        <div class="conversation-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                        </div>
                        <div class="conversation-title">${conv.title}</div>
                    </div>
                    <div class="conversation-actions">
                        <button class="delete-conversation" data-id="${conv.id}" title="${currentLanguage === 'vi' ? 'Xóa cuộc trò chuyện' : 'Delete conversation'}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                `;
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-conversation')) {
                        showConversation(conv.id);
                    }
                });
                
                // Thêm sự kiện xóa cuộc trò chuyện
                const deleteBtn = item.querySelector('.delete-conversation');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    conversationToDelete = conv.id;
                    deleteModal.classList.add('active');
                });
                
                conversationList.appendChild(item);
            });
        }

        // Xóa cuộc trò chuyện
        function deleteConversation() {
            if (conversationToDelete) {
                delete conversations[conversationToDelete];
                
                // Nếu đang xem cuộc trò chuyện bị xóa, chuyển sang cuộc trò chuyện khác
                if (currentConversationId === conversationToDelete) {
                    const remainingIds = Object.keys(conversations);
                    if (remainingIds.length > 0) {
                        currentConversationId = remainingIds[0];
                        showConversation(currentConversationId);
                    } else {
                        // Tạo cuộc trò chuyện mới nếu không còn cuộc trò chuyện nào
                        createNewConversation();
                    }
                }
                
                saveConversations();
                renderConversationList();
                deleteModal.classList.remove('active');
                conversationToDelete = null;
                
                showToast(currentLanguage === 'vi' ? 'Đã xóa cuộc trò chuyện' : 'Conversation deleted');
            }
        }

        // Đăng xuất
        function logout() {
            localStorage.removeItem('userEmail');
            showToast(currentLanguage === 'vi' ? 'Đã đăng xuất' : 'Logged out');
            // Trong thực tế, bạn sẽ chuyển hướng đến trang đăng nhập
        }

        // Áp dụng theme
        function applyTheme() {
            if (currentTheme === 'system') {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
            } else if (currentTheme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        // Áp dụng cỡ chữ
        function applyFontSize() {
            document.body.classList.remove('font-small', 'font-medium', 'font-large', 'font-xlarge');
            document.body.classList.add(`font-${currentFontSize}`);
        }

        // Áp dụng ngôn ngữ
        function applyLanguage() {
            const t = translations[currentLanguage];
            
            // Cập nhật tất cả các phần tử có id
            document.getElementById('sidebarTitle').textContent = t.sidebarTitle;
            document.getElementById('chatbotTitle').textContent = t.chatbotTitle;
            document.getElementById('emptyChatTitle').textContent = t.emptyChatTitle;
            document.getElementById('emptyChatDesc').textContent = t.emptyChatDesc;
            document.getElementById('newChatButtonText').textContent = t.newChatButtonText;
            document.getElementById('settingsTitle').textContent = t.settingsTitle;
            document.getElementById('profileTitle').textContent = t.profileTitle;
            document.getElementById('emailLabel').textContent = t.emailLabel;
            document.getElementById('appTitle').textContent = t.appTitle;
            document.getElementById('languageLabel').textContent = t.languageLabel;
            document.getElementById('themeLabel').textContent = t.themeLabel;
            document.getElementById('fontSizeLabel').textContent = t.fontSizeLabel;
            document.getElementById('botPersonalityTitle').textContent = t.botPersonalityTitle;
            document.getElementById('performanceTitle').textContent = t.performanceTitle;
            document.getElementById('animationsLabel').textContent = t.animationsLabel;
            document.getElementById('colorsLabel').textContent = t.colorsLabel;
            document.getElementById('aboutTitle').textContent = t.aboutTitle;
            document.getElementById('checkUpdateLabel').textContent = t.checkUpdateLabel;
            document.getElementById('contactLabel').textContent = t.contactLabel;
            document.getElementById('deleteModalTitle').textContent = t.deleteModalTitle;
            document.getElementById('deleteModalMessage').textContent = t.deleteModalMessage;
            
            // Cập nhật placeholder
            document.getElementById('chatInput').placeholder = t.chatInputPlaceholder;
            
            // Cập nhật tiêu đề cuộc trò chuyện mặc định
            if (conversations['default']) {
                conversations['default'].title = t.emptyChatTitle;
            }
            
            // Render lại danh sách cuộc trò chuyện
            renderConversationList();
        }

        // Áp dụng cài đặt hiệu suất
        function applyPerformanceSettings() {
            if (animationsEnabled) {
                document.body.classList.remove('no-animations');
            } else {
                document.body.classList.add('no-animations');
            }
            
            if (colorsEnabled) {
                document.body.classList.remove('no-colors');
            } else {
                document.body.classList.add('no-colors');
            }
        }

        // Lưu cài đặt
        function saveSettings() {
            const settings = {
                theme: currentTheme,
                language: currentLanguage,
                fontSize: currentFontSize,
                personality: currentPersonality,
                animations: animationsEnabled,
                colors: colorsEnabled
            };
            localStorage.setItem('chatbotSettings', JSON.stringify(settings));
        }

        // Tải cài đặt
        function loadSettings() {
            const savedSettings = localStorage.getItem('chatbotSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                currentTheme = settings.theme || 'system';
                currentLanguage = settings.language || 'vi';
                currentFontSize = settings.fontSize || 'medium';
                currentPersonality = settings.personality || 'normal';
                animationsEnabled = settings.animations !== undefined ? settings.animations : true;
                colorsEnabled = settings.colors !== undefined ? settings.colors : true;
                
                // Cập nhật UI
                document.querySelectorAll('[data-theme]').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === currentTheme);
                });
                document.querySelectorAll('[data-lang]').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.lang === currentLanguage);
                });
                document.querySelectorAll('[data-size]').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.size === currentFontSize);
                });
                document.querySelectorAll('[data-personality]').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.personality === currentPersonality);
                });
                document.querySelectorAll('[data-animations]').forEach(btn => {
                    btn.classList.toggle('active', (btn.dataset.animations === 'on') === animationsEnabled);
                });
                document.querySelectorAll('[data-colors]').forEach(btn => {
                    btn.classList.toggle('active', (btn.dataset.colors === 'on') === colorsEnabled);
                });
                
                // Áp dụng cài đặt hiệu suất
                applyPerformanceSettings();
            }
        }

        // Lưu cuộc trò chuyện
        function saveConversations() {
            localStorage.setItem('chatbotConversations', JSON.stringify(conversations));
            localStorage.setItem('currentConversationId', currentConversationId);
        }

        // Tải cuộc trò chuyện
        function loadConversations() {
            const savedConversations = localStorage.getItem('chatbotConversations');
            const savedCurrentId = localStorage.getItem('currentConversationId');
            
            if (savedConversations) {
                conversations = JSON.parse(savedConversations);
            }
            
            if (savedCurrentId) {
                currentConversationId = savedCurrentId;
            }
            
            // Nếu không có cuộc trò chuyện nào, tạo mặc định
            if (Object.keys(conversations).length === 0) {
                currentConversationId = 'default';
                conversations[currentConversationId] = {
                    id: currentConversationId,
                    title: currentLanguage === 'vi' ? 'Cuộc trò chuyện mới' : 'New conversation',
                    messages: []
                };
            }
        }

        // Khởi chạy ứng dụng
        initApp();
    </script>
</body>
</html>